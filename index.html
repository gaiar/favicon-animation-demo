<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Animated Favicon Demo - Zalando Lounge</title>

    <!-- Dynamic favicon - will be replaced by JavaScript -->
    <link id="favicon" rel="icon" type="image/png" href="assets/favicon_32.png">

    <style>
        :root {
            --primary: #ff6900;
            --secondary: #1a1a2e;
            --background: #0f0f23;
            --text: #ffffff;
            --card-bg: #1a1a2e;
            --border: #333;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--background);
            color: var(--text);
            min-height: 100vh;
            padding: 2rem;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 3rem;
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, var(--primary), #ff9500);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            color: #888;
            font-size: 1.1rem;
        }

        .info-box {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .info-box h3 {
            color: var(--primary);
            margin-bottom: 1rem;
        }

        .info-box ul {
            margin-left: 1.5rem;
            line-height: 1.8;
        }

        .demo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .demo-card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .demo-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 40px rgba(255, 105, 0, 0.2);
        }

        .demo-card h3 {
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .badge {
            font-size: 0.7rem;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            text-transform: uppercase;
            font-weight: bold;
        }

        .badge-simple { background: #22c55e; }
        .badge-strong { background: #eab308; color: #000; }
        .badge-disturbing { background: #ef4444; }
        .badge-nightmare { background: #7c3aed; animation: nightmareBadge 0.5s infinite; }

        @keyframes nightmareBadge {
            0%, 100% { background: #7c3aed; }
            50% { background: #dc2626; }
        }

        .preview-container {
            display: flex;
            align-items: center;
            gap: 2rem;
            margin: 1.5rem 0;
        }

        .favicon-preview {
            width: 64px;
            height: 64px;
            border: 2px solid var(--border);
            border-radius: 8px;
            background: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .favicon-preview canvas,
        .favicon-preview svg,
        .favicon-preview img {
            width: 32px;
            height: 32px;
        }

        .tab-preview {
            background: #2a2a3e;
            border-radius: 8px 8px 0 0;
            padding: 0.5rem 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
        }

        .tab-favicon {
            width: 16px;
            height: 16px;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.6rem 1.2rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        button:hover {
            background: #ff8533;
            transform: scale(1.02);
        }

        button:active {
            transform: scale(0.98);
        }

        button.active {
            box-shadow: 0 0 0 3px rgba(255, 105, 0, 0.5);
        }

        button.secondary {
            background: var(--secondary);
            border: 1px solid var(--border);
        }

        button.secondary:hover {
            background: #252540;
        }

        button.nightmare-btn {
            background: linear-gradient(45deg, #7c3aed, #dc2626);
            animation: nightmareBtn 1s infinite;
        }

        @keyframes nightmareBtn {
            0%, 100% { filter: brightness(1); }
            50% { filter: brightness(1.3); }
        }

        .slider-container {
            margin-top: 1rem;
        }

        .slider-container label {
            display: block;
            margin-bottom: 0.5rem;
            color: #888;
        }

        input[type="range"] {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: var(--border);
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
        }

        .global-controls {
            background: linear-gradient(135deg, var(--card-bg), #252540);
            border: 2px solid var(--primary);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .global-controls h2 {
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .control-row {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            justify-content: center;
            margin-bottom: 1rem;
        }

        .warning {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid #ef4444;
            border-radius: 6px;
            padding: 1rem;
            margin-top: 1rem;
            font-size: 0.9rem;
        }

        .nightmare-warning {
            background: linear-gradient(45deg, rgba(124, 58, 237, 0.3), rgba(220, 38, 38, 0.3));
            border: 2px solid #7c3aed;
            animation: warningPulse 1s infinite;
        }

        @keyframes warningPulse {
            0%, 100% { border-color: #7c3aed; }
            50% { border-color: #dc2626; }
        }

        .browser-support {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .browser {
            text-align: center;
            padding: 1rem;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
        }

        .browser-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .supported { color: #22c55e; }
        .partial { color: #eab308; }
        .unsupported { color: #ef4444; }

        footer {
            text-align: center;
            margin-top: 3rem;
            padding-top: 2rem;
            border-top: 1px solid var(--border);
            color: #666;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
            animation: statusPulse 1s infinite;
        }

        .status-active { background: #22c55e; }
        .status-inactive { background: #666; animation: none; }

        @keyframes statusPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Animated Favicon Demo</h1>
            <p class="subtitle">Exploring favicon animations based on Zalando Lounge branding</p>
        </header>

        <div class="info-box">
            <h3>Key Findings from Research</h3>
            <ul>
                <li><strong>BIMI logos cannot be animated</strong> - They require SVG Tiny PS format which prohibits animations for security</li>
                <li><strong>Favicons CAN be animated</strong> using JavaScript canvas manipulation (works in all browsers)</li>
                <li><strong>Method:</strong> Replace the favicon link element with new data URL on each frame</li>
                <li><strong>Performance:</strong> Throttled to ~30fps to avoid browser strain</li>
            </ul>
        </div>

        <div class="global-controls">
            <h2><span class="status-indicator status-inactive" id="status-dot"></span>Favicon Animation Controls</h2>
            <div class="control-row">
                <button onclick="setAnimation('none')" class="secondary" id="btn-none">No Animation</button>
                <button onclick="setAnimation('simple')" id="btn-simple">Simple (Pulse)</button>
                <button onclick="setAnimation('strong')" id="btn-strong">Strong (Bounce)</button>
                <button onclick="setAnimation('disturbing')" id="btn-disturbing">Disturbing (Strobe)</button>
                <button onclick="setAnimation('nightmare')" id="btn-nightmare" class="nightmare-btn">NIGHTMARE</button>
            </div>
            <div class="slider-container">
                <label>Animation Speed: <span id="speed-value">1.0x</span></label>
                <input type="range" id="speed-slider" min="0.1" max="5" step="0.1" value="1" oninput="updateSpeed(this.value)">
            </div>
            <div class="tab-preview" style="max-width: 350px; margin: 1rem auto 0;">
                <canvas id="tab-favicon-preview" class="tab-favicon" width="16" height="16"></canvas>
                <span>Look at your browser tab!</span>
            </div>
        </div>

        <div class="demo-grid">
            <!-- Simple Animation -->
            <div class="demo-card">
                <h3>
                    <span class="badge badge-simple">Simple</span>
                    Gentle Pulse
                </h3>
                <p>Subtle breathing effect. Good for notifications.</p>

                <div class="preview-container">
                    <div class="favicon-preview">
                        <canvas id="preview-simple" width="32" height="32"></canvas>
                    </div>
                    <div>
                        <strong>Effect:</strong> Scale + Opacity<br>
                        <strong>Intensity:</strong> Low
                    </div>
                </div>

                <div class="controls">
                    <button onclick="setAnimation('simple')">Apply to Tab</button>
                </div>
            </div>

            <!-- Strong Animation -->
            <div class="demo-card">
                <h3>
                    <span class="badge badge-strong">Strong</span>
                    Bounce & Spin
                </h3>
                <p>Noticeable movement for urgent notifications.</p>

                <div class="preview-container">
                    <div class="favicon-preview">
                        <canvas id="preview-strong" width="32" height="32"></canvas>
                    </div>
                    <div>
                        <strong>Effect:</strong> Bounce + Rotate<br>
                        <strong>Intensity:</strong> Medium
                    </div>
                </div>

                <div class="controls">
                    <button onclick="setAnimation('strong')">Apply to Tab</button>
                </div>
            </div>

            <!-- Disturbing Animation -->
            <div class="demo-card">
                <h3>
                    <span class="badge badge-disturbing">Disturbing</span>
                    Strobe & Shake
                </h3>
                <p>Color shifting and rapid shaking.</p>

                <div class="preview-container">
                    <div class="favicon-preview">
                        <canvas id="preview-disturbing" width="32" height="32"></canvas>
                    </div>
                    <div>
                        <strong>Effect:</strong> Hue shift + Shake<br>
                        <strong>Intensity:</strong> High
                    </div>
                </div>

                <div class="controls">
                    <button onclick="setAnimation('disturbing')">Apply to Tab</button>
                </div>

                <div class="warning">
                    <strong>Warning:</strong> May cause discomfort for photosensitive users.
                </div>
            </div>

            <!-- NIGHTMARE Animation -->
            <div class="demo-card" style="border-color: #7c3aed;">
                <h3>
                    <span class="badge badge-nightmare">NIGHTMARE</span>
                    Total Chaos
                </h3>
                <p>Extreme multi-effect madness. For those who want to suffer.</p>

                <div class="preview-container">
                    <div class="favicon-preview" style="border-color: #7c3aed;">
                        <canvas id="preview-nightmare" width="32" height="32"></canvas>
                    </div>
                    <div>
                        <strong>Effect:</strong> EVERYTHING<br>
                        <strong>Intensity:</strong> MAXIMUM
                    </div>
                </div>

                <div class="controls">
                    <button onclick="setAnimation('nightmare')" class="nightmare-btn">Unleash Chaos</button>
                </div>

                <div class="warning nightmare-warning">
                    <strong>EXTREME WARNING:</strong> Combines rapid flashing, color inversion, glitch effects, shake, scale distortion, and frame skipping. NOT for the faint of heart. May cause headaches, eye strain, or existential dread.
                </div>
            </div>

            <!-- Original Static -->
            <div class="demo-card">
                <h3>Original Static</h3>
                <p>The original Zalando Lounge favicon.</p>

                <div class="preview-container">
                    <div class="favicon-preview">
                        <img src="assets/favicon_32.png" alt="Original favicon" id="original-favicon">
                    </div>
                    <div>
                        <strong>Source:</strong> mosaic01.ztat.net<br>
                        <strong>Format:</strong> PNG 32x32
                    </div>
                </div>

                <div class="controls">
                    <button onclick="setAnimation('none')" class="secondary">Reset to Static</button>
                </div>
            </div>
        </div>

        <div class="info-box">
            <h3>Browser Support</h3>
            <div class="browser-support">
                <div class="browser">
                    <div class="browser-icon">ü¶ä</div>
                    <div class="supported">Firefox</div>
                    <small>Full support</small>
                </div>
                <div class="browser">
                    <div class="browser-icon">üåê</div>
                    <div class="supported">Chrome</div>
                    <small>Full support</small>
                </div>
                <div class="browser">
                    <div class="browser-icon">üß≠</div>
                    <div class="partial">Safari</div>
                    <small>Partial</small>
                </div>
                <div class="browser">
                    <div class="browser-icon">üìò</div>
                    <div class="supported">Edge</div>
                    <small>Full support</small>
                </div>
            </div>
        </div>

        <footer>
            <p>Demo for animated favicon techniques | Zalando Lounge branding</p>
        </footer>
    </div>

    <script>
        // Favicon animation system with proper link element replacement
        const faviconImg = new Image();
        faviconImg.crossOrigin = 'anonymous';
        faviconImg.src = 'assets/favicon_64.png';

        let currentAnimation = 'none';
        let animationSpeed = 1;
        let animationFrameIds = {};
        let lastFaviconUpdate = 0;
        const FAVICON_UPDATE_INTERVAL = 33; // ~30fps for favicon updates

        // Wait for image to load
        faviconImg.onload = function() {
            console.log('Favicon image loaded successfully');

            // Initialize all preview canvases
            initPreviewCanvas('preview-simple');
            initPreviewCanvas('preview-strong');
            initPreviewCanvas('preview-disturbing');
            initPreviewCanvas('preview-nightmare');
            initPreviewCanvas('tab-favicon-preview', 16);

            // Start all preview animations
            startPreviewAnimation('simple', 'preview-simple');
            startPreviewAnimation('strong', 'preview-strong');
            startPreviewAnimation('disturbing', 'preview-disturbing');
            startPreviewAnimation('nightmare', 'preview-nightmare');
        };

        faviconImg.onerror = function() {
            console.error('Failed to load favicon image');
        };

        function initPreviewCanvas(canvasId, size = 32) {
            const canvas = document.getElementById(canvasId);
            if (canvas) {
                const ctx = canvas.getContext('2d');
                ctx.drawImage(faviconImg, 0, 0, size, size);
            }
        }

        function startPreviewAnimation(type, canvasId) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            const size = canvas.width;
            let startTime = performance.now();

            function animate(currentTime) {
                const elapsed = (currentTime - startTime) / 1000 * animationSpeed;

                ctx.clearRect(0, 0, size, size);
                ctx.save();
                ctx.translate(size / 2, size / 2);

                applyAnimation(ctx, type, elapsed, size);

                ctx.drawImage(faviconImg, -size / 2, -size / 2, size, size);
                ctx.restore();

                // Apply post-processing effects
                if (type === 'disturbing' || type === 'nightmare') {
                    applyPostEffects(ctx, type, elapsed, size);
                }

                animationFrameIds[canvasId] = requestAnimationFrame(animate);
            }

            if (animationFrameIds[canvasId]) {
                cancelAnimationFrame(animationFrameIds[canvasId]);
            }
            animate(performance.now());
        }

        function applyAnimation(ctx, type, elapsed, size) {
            switch (type) {
                case 'simple':
                    const pulseScale = 0.85 + 0.15 * Math.sin(elapsed * Math.PI);
                    const pulseOpacity = 0.7 + 0.3 * Math.sin(elapsed * Math.PI);
                    ctx.scale(pulseScale, pulseScale);
                    ctx.globalAlpha = pulseOpacity;
                    break;

                case 'strong':
                    const bounceY = -6 * Math.abs(Math.sin(elapsed * 6 * Math.PI));
                    const rotation = Math.sin(elapsed * 6 * Math.PI) * 0.4;
                    const bounceScale = 1 + 0.1 * Math.abs(Math.sin(elapsed * 6 * Math.PI));
                    ctx.translate(0, bounceY);
                    ctx.rotate(rotation);
                    ctx.scale(bounceScale, bounceScale);
                    break;

                case 'disturbing':
                    const shakeX = (Math.random() - 0.5) * 8;
                    const shakeY = (Math.random() - 0.5) * 8;
                    const disturbScale = 0.9 + Math.random() * 0.2;
                    ctx.translate(shakeX, shakeY);
                    ctx.scale(disturbScale, disturbScale);
                    ctx.rotate((Math.random() - 0.5) * 0.3);
                    break;

                case 'nightmare':
                    // Extreme multi-effect chaos
                    const chaos = Math.random();
                    const nightmareShakeX = (Math.random() - 0.5) * 16;
                    const nightmareShakeY = (Math.random() - 0.5) * 16;
                    const nightmareScale = 0.5 + Math.random() * 1.0;
                    const nightmareRotation = (Math.random() - 0.5) * Math.PI;
                    const skewX = (Math.random() - 0.5) * 0.5;
                    const skewY = (Math.random() - 0.5) * 0.5;

                    ctx.translate(nightmareShakeX, nightmareShakeY);
                    ctx.rotate(nightmareRotation);
                    ctx.scale(nightmareScale, nightmareScale * (0.8 + Math.random() * 0.4));
                    ctx.transform(1, skewX, skewY, 1, 0, 0);

                    // Random opacity flicker
                    ctx.globalAlpha = 0.3 + Math.random() * 0.7;
                    break;
            }
        }

        function applyPostEffects(ctx, type, elapsed, size) {
            try {
                const imageData = ctx.getImageData(0, 0, size, size);
                const data = imageData.data;

                if (type === 'disturbing') {
                    // Hue rotation
                    const hue = (elapsed * 360 * 5) % 360;
                    shiftHue(data, hue);
                } else if (type === 'nightmare') {
                    // Random extreme effects
                    const effect = Math.floor(Math.random() * 5);

                    switch (effect) {
                        case 0: // Color inversion
                            for (let i = 0; i < data.length; i += 4) {
                                data[i] = 255 - data[i];
                                data[i + 1] = 255 - data[i + 1];
                                data[i + 2] = 255 - data[i + 2];
                            }
                            break;
                        case 1: // Extreme saturation
                            shiftHue(data, Math.random() * 360);
                            for (let i = 0; i < data.length; i += 4) {
                                const avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
                                data[i] = Math.min(255, data[i] + (data[i] - avg) * 2);
                                data[i + 1] = Math.min(255, data[i + 1] + (data[i + 1] - avg) * 2);
                                data[i + 2] = Math.min(255, data[i + 2] + (data[i + 2] - avg) * 2);
                            }
                            break;
                        case 2: // Glitch - channel shift
                            const shift = Math.floor(Math.random() * 20);
                            for (let i = 0; i < data.length - shift * 4; i += 4) {
                                data[i] = data[i + shift * 4];
                            }
                            break;
                        case 3: // Posterize
                            const levels = 2 + Math.floor(Math.random() * 3);
                            for (let i = 0; i < data.length; i += 4) {
                                data[i] = Math.floor(data[i] / (256 / levels)) * (256 / levels);
                                data[i + 1] = Math.floor(data[i + 1] / (256 / levels)) * (256 / levels);
                                data[i + 2] = Math.floor(data[i + 2] / (256 / levels)) * (256 / levels);
                            }
                            break;
                        case 4: // Scanlines + noise
                            for (let i = 0; i < data.length; i += 4) {
                                const y = Math.floor(i / 4 / size);
                                if (y % 2 === 0) {
                                    const noise = (Math.random() - 0.5) * 100;
                                    data[i] = Math.min(255, Math.max(0, data[i] + noise));
                                    data[i + 1] = Math.min(255, Math.max(0, data[i + 1] + noise));
                                    data[i + 2] = Math.min(255, Math.max(0, data[i + 2] + noise));
                                } else {
                                    data[i] = data[i] * 0.5;
                                    data[i + 1] = data[i + 1] * 0.5;
                                    data[i + 2] = data[i + 2] * 0.5;
                                }
                            }
                            break;
                    }
                }

                ctx.putImageData(imageData, 0, 0);
            } catch (e) {
                // Canvas tainted - ignore
            }
        }

        function shiftHue(data, hue) {
            const hueRad = hue * Math.PI / 180;
            const cos = Math.cos(hueRad);
            const sin = Math.sin(hueRad);

            for (let i = 0; i < data.length; i += 4) {
                const r = data[i];
                const g = data[i + 1];
                const b = data[i + 2];

                data[i] = Math.min(255, Math.max(0,
                    r * (0.213 + cos * 0.787 - sin * 0.213) +
                    g * (0.715 - cos * 0.715 - sin * 0.715) +
                    b * (0.072 - cos * 0.072 + sin * 0.928)
                ));
                data[i + 1] = Math.min(255, Math.max(0,
                    r * (0.213 - cos * 0.213 + sin * 0.143) +
                    g * (0.715 + cos * 0.285 + sin * 0.140) +
                    b * (0.072 - cos * 0.072 - sin * 0.283)
                ));
                data[i + 2] = Math.min(255, Math.max(0,
                    r * (0.213 - cos * 0.213 - sin * 0.787) +
                    g * (0.715 - cos * 0.715 + sin * 0.715) +
                    b * (0.072 + cos * 0.928 + sin * 0.072)
                ));
            }
        }

        function setAnimation(type) {
            currentAnimation = type;

            // Update button states
            document.querySelectorAll('.control-row button').forEach(btn => {
                btn.classList.remove('active');
            });
            const activeBtn = document.getElementById(`btn-${type}`);
            if (activeBtn) activeBtn.classList.add('active');

            // Update status indicator
            const statusDot = document.getElementById('status-dot');
            if (type === 'none') {
                statusDot.className = 'status-indicator status-inactive';
            } else {
                statusDot.className = 'status-indicator status-active';
            }

            if (type === 'none') {
                // Stop animation and reset favicon
                if (animationFrameIds['tab']) {
                    cancelAnimationFrame(animationFrameIds['tab']);
                    animationFrameIds['tab'] = null;
                }
                resetFavicon();

                // Reset tab preview
                const tabCanvas = document.getElementById('tab-favicon-preview');
                const ctx = tabCanvas.getContext('2d');
                ctx.clearRect(0, 0, 16, 16);
                ctx.drawImage(faviconImg, 0, 0, 16, 16);
            } else {
                startTabFaviconAnimation(type);
            }

            console.log('Animation set to:', type);
        }

        function startTabFaviconAnimation(type) {
            // Canvas for generating favicon frames
            const canvas = document.createElement('canvas');
            canvas.width = 32;
            canvas.height = 32;
            const ctx = canvas.getContext('2d');

            // Tab preview canvas
            const tabCanvas = document.getElementById('tab-favicon-preview');
            const tabCtx = tabCanvas.getContext('2d');

            let startTime = performance.now();
            let frameCount = 0;

            function animate(currentTime) {
                const elapsed = (currentTime - startTime) / 1000 * animationSpeed;
                frameCount++;

                // Update main favicon canvas
                ctx.clearRect(0, 0, 32, 32);
                ctx.save();
                ctx.translate(16, 16);
                applyAnimation(ctx, type, elapsed, 32);
                ctx.drawImage(faviconImg, -16, -16, 32, 32);
                ctx.restore();

                // Apply post effects
                if (type === 'disturbing' || type === 'nightmare') {
                    applyPostEffects(ctx, type, elapsed, 32);
                }

                // Update tab preview
                tabCtx.clearRect(0, 0, 16, 16);
                tabCtx.drawImage(canvas, 0, 0, 16, 16);

                // Update actual browser favicon (throttled)
                if (currentTime - lastFaviconUpdate > FAVICON_UPDATE_INTERVAL) {
                    updateBrowserFavicon(canvas);
                    lastFaviconUpdate = currentTime;
                }

                animationFrameIds['tab'] = requestAnimationFrame(animate);
            }

            if (animationFrameIds['tab']) {
                cancelAnimationFrame(animationFrameIds['tab']);
            }
            animate(performance.now());
        }

        function updateBrowserFavicon(canvas) {
            // Get data URL from canvas
            const dataUrl = canvas.toDataURL('image/png');

            // Remove existing favicon links
            const existingLinks = document.querySelectorAll("link[rel*='icon']");
            existingLinks.forEach(link => link.remove());

            // Create new favicon link
            const newLink = document.createElement('link');
            newLink.id = 'favicon';
            newLink.rel = 'icon';
            newLink.type = 'image/png';
            newLink.href = dataUrl;

            // Append to head
            document.head.appendChild(newLink);
        }

        function resetFavicon() {
            // Remove existing favicon links
            const existingLinks = document.querySelectorAll("link[rel*='icon']");
            existingLinks.forEach(link => link.remove());

            // Create new static favicon link
            const newLink = document.createElement('link');
            newLink.id = 'favicon';
            newLink.rel = 'icon';
            newLink.type = 'image/png';
            newLink.href = 'assets/favicon_32.png';

            document.head.appendChild(newLink);
        }

        function updateSpeed(value) {
            animationSpeed = parseFloat(value);
            document.getElementById('speed-value').textContent = value + 'x';

            // Restart animations with new speed
            startPreviewAnimation('simple', 'preview-simple');
            startPreviewAnimation('strong', 'preview-strong');
            startPreviewAnimation('disturbing', 'preview-disturbing');
            startPreviewAnimation('nightmare', 'preview-nightmare');

            if (currentAnimation !== 'none') {
                startTabFaviconAnimation(currentAnimation);
            }
        }

        // Respect reduced motion preference (but allow override)
        if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
            document.body.insertAdjacentHTML('afterbegin',
                '<div class="warning" style="margin: 1rem 2rem;">Reduced motion preference detected. Animations available but not auto-started.</div>'
            );
        }
    </script>
</body>
</html>
